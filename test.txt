  
  provisioner "remote-exec" {
    inline = [
      "sudo yum update -y",
      "sudo yum install -y docker",
      "sudo service docker start",
      "sudo usermod -a -G docker ec2-user",
      "sudo yum install -y git",
      "git clone https://github.com/docker/compose.git /tmp/docker-compose",
      "sudo cp /tmp/docker-compose/bin/docker-compose /usr/local/bin/docker-compose",
      "sudo chmod +x /usr/local/bin/docker-compose",
      "sudo mkdir -p /opt/docker-compose",
      "sudo chown -R ec2-user:ec2-user /opt/docker-compose",
      "sudo chmod -R 775 /opt/docker-compose",
      "exit"
    ]
  }

  connection {
    type        = "ssh"
    user        = "ec2-user"
    private_key = file("tp_devops.pem") 
    host        = self.public_ip
  }
}

resource "null_resource" "install_docker_compose" {
  depends_on = [aws_instance.app_server]

  connection {
    type        = "ssh"
    user        = "ec2-user"
    private_key = file("tp_devops.pem") 
    host        = aws_instance.app_server.public_ip
  }

  provisioner "remote-exec" {
    inline = [
      "sudo curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose",
      "sudo chmod +x /usr/local/bin/docker-compose",
      "docker-compose --version",  
    ]
  }
}


resource "null_resource" "copy_docker_compose" {
  depends_on = [null_resource.install_docker_compose]

  connection {
    type        = "ssh"
    user        = "ec2-user"
    private_key = file("tp_devops.pem") 
    host        = aws_instance.app_server.public_ip
  }

  provisioner "file" {
    source      = "./docker-compose.yml" 
    destination = "/tmp/docker-compose/docker-compose.yml"
  }
}

resource "null_resource" "execute_docker_compose" {
  depends_on = [null_resource.copy_docker_compose]

  count = 1
  
  connection {
    type        = "ssh"
    user        = "ec2-user"
    private_key = file("tp_devops.pem") 
    host        = aws_instance.app_server.public_ip
  }
  provisioner "remote-exec" {
    inline = [
      "cd /tmp/docker-compose",
      "docker-compose -f docker-compose.yml up --build -d",
    ]
  }
}